#include <cstdio>
#include <cstdlib>
#include <string>
#include <thread>
#include <mutex>
#include <vector>
#include <cstdint>
#include <cstring>

#include "solver.hpp"

FILE* ffmpeg = nullptr;
std::mutex ffmpeg_mutex;
std::atomic<bool> streaming_active(false);

const uint8_t viridis[256][3] = {
    { 68,  1, 84}, { 68,  2, 86}, { 69,  4, 87}, { 69,  5, 89},
    { 70,  7, 90}, { 70,  8, 92}, { 70, 10, 93}, { 70, 11, 94},
    { 71, 13, 96}, { 71, 14, 97}, { 71, 16, 98}, { 71, 17,100},
    { 72, 19,101}, { 72, 20,102}, { 72, 22,103}, { 72, 23,105},
    { 72, 24,106}, { 72, 26,107}, { 72, 27,108}, { 72, 29,110},
    { 72, 30,111}, { 72, 32,112}, { 72, 33,113}, { 72, 35,114},
    { 72, 36,116}, { 72, 38,117}, { 71, 39,118}, { 71, 41,119},
    { 71, 42,120}, { 71, 44,121}, { 70, 45,122}, { 70, 47,123},
    { 70, 48,124}, { 69, 50,125}, { 69, 51,126}, { 69, 53,127},
    { 68, 54,128}, { 68, 56,129}, { 67, 57,130}, { 67, 59,131},
    { 66, 60,132}, { 66, 62,133}, { 65, 63,134}, { 65, 65,135},
    { 64, 66,136}, { 64, 68,137}, { 63, 69,137}, { 62, 71,138},
    { 62, 72,139}, { 61, 74,140}, { 61, 75,141}, { 60, 77,142},
    { 59, 78,142}, { 59, 80,143}, { 58, 81,144}, { 57, 83,145},
    { 57, 84,145}, { 56, 86,146}, { 55, 87,147}, { 55, 89,147},
    { 54, 90,148}, { 53, 92,149}, { 53, 93,149}, { 52, 95,150},
    { 51, 96,151}, { 51, 98,151}, { 50, 99,152}, { 49,101,152},
    { 49,102,153}, { 48,104,153}, { 47,105,154}, { 47,107,154},
    { 46,108,155}, { 45,110,155}, { 45,111,156}, { 44,113,156},
    { 43,114,157}, { 43,116,157}, { 42,117,157}, { 41,119,158},
    { 41,120,158}, { 40,122,158}, { 39,123,159}, { 39,125,159},
    { 38,126,159}, { 37,128,160}, { 37,129,160}, { 36,131,160},
    { 35,132,161}, { 35,134,161}, { 34,135,161}, { 33,137,161},
    { 33,138,162}, { 32,140,162}, { 31,141,162}, { 31,143,162},
    { 30,144,162}, { 29,146,163}, { 29,147,163}, { 28,149,163},
    { 27,150,163}, { 27,152,163}, { 26,153,163}, { 25,155,163},
    { 25,156,164}, { 24,158,164}, { 24,159,164}, { 23,161,164},
    { 22,162,164}, { 22,164,164}, { 21,165,164}, { 20,167,164},
    { 20,168,164}, { 19,170,164}, { 19,171,164}, { 18,173,164},
    { 17,174,164}, { 17,176,164}, { 16,177,164}, { 15,179,164},
    { 15,180,164}, { 14,182,164}, { 14,183,164}, { 13,185,164},
    { 13,186,163}, { 12,188,163}, { 12,189,163}, { 11,191,163},
    { 11,192,163}, { 10,194,162}, { 10,195,162}, { 10,197,162},
    { 10,198,161}, { 10,200,161}, { 10,201,161}, { 10,203,160},
    { 10,204,160}, { 11,206,159}, { 11,207,159}, { 12,209,158},
    { 13,210,158}, { 14,212,157}, { 15,213,157}, { 16,215,156},
    { 18,216,155}, { 19,218,155}, { 21,219,154}, { 22,221,153},
    { 24,222,152}, { 26,223,152}, { 28,225,151}, { 30,226,150},
    { 32,228,149}, { 34,229,148}, { 36,230,147}, { 38,232,146},
    { 40,233,145}, { 43,234,144}, { 45,236,143}, { 47,237,142},
    { 50,238,141}, { 52,240,140}, { 55,241,139}, { 57,242,138},
    { 60,243,137}, { 62,244,135}, { 65,245,134}, { 67,246,133},
    { 70,247,132}, { 73,248,130}, { 75,249,129}, { 78,250,128},
    { 81,251,126}, { 83,252,125}, { 86,253,123}, { 89,254,122},
    { 91,254,120}, { 94,255,119}, { 97,255,117}, {100,255,116},
    {102,255,114}, {105,255,113}, {108,255,111}, {111,255,109},
    {113,255,108}, {116,254,106}, {119,254,105}, {122,254,103},
    {125,253,101}, {127,253,100}, {130,252, 98}, {133,252, 96},
    {136,251, 94}, {139,251, 93}, {142,250, 91}, {145,249, 89},
    {148,249, 88}, {151,248, 86}, {154,247, 84}, {157,246, 83},
    {160,245, 81}, {163,244, 79}, {166,243, 77}, {169,242, 76},
    {172,241, 74}, {175,240, 72}, {178,239, 70}, {181,237, 69},
    {184,236, 67}, {187,235, 65}, {190,233, 64}, {193,232, 62},
    {196,231, 60}, {199,229, 58}, {202,228, 57}, {205,226, 55},
    {208,225, 54}, {211,223, 52}, {214,221, 51}, {217,220, 49},
    {220,218, 48}, {223,216, 46}, {225,215, 45}, {228,213, 43},
    {231,211, 42}, {234,209, 41}, {236,207, 39}, {239,206, 38},
    {242,204, 37}, {244,202, 36}, {247,200, 35}, {249,198, 33},
    {252,196, 32}, {254,194, 31}, {255,192, 30}, {255,190, 29},
    {255,188, 28}, {255,186, 27}, {255,184, 26}, {255,182, 25},
    {255,180, 24}, {255,178, 23}, {255,176, 22}, {255,174, 21},
    {255,172, 20}, {255,170, 19}, {255,168, 18}, {255,166, 17},
    {255,164, 16}, {255,162, 15}, {255,160, 14}, {255,158, 13},
    {255,156, 12}, {255,154, 11}, {255,152, 10}, {255,150,  9},
};

unsigned char seismic[256][3] = {
    {   0,   0,  76 },    {   0,   0,  79 },    {   0,   0,  82 },    {   0,   0,  84 },    {   0,   0,  87 },    {   0,   0,  90 },    {   0,   0,  93 },    {   0,   0,  96 },
    {   0,   0,  98 },    {   0,   0, 101 },    {   0,   0, 104 },    {   0,   0, 107 },    {   0,   0, 110 },    {   0,   0, 112 },    {   0,   0, 115 },    {   0,   0, 118 },
    {   0,   0, 121 },    {   0,   0, 124 },    {   0,   0, 126 },    {   0,   0, 129 },    {   0,   0, 132 },    {   0,   0, 135 },    {   0,   0, 138 },    {   0,   0, 140 },
    {   0,   0, 143 },    {   0,   0, 146 },    {   0,   0, 149 },    {   0,   0, 152 },    {   0,   0, 154 },    {   0,   0, 157 },    {   0,   0, 160 },    {   0,   0, 163 },
    {   0,   0, 166 },    {   0,   0, 168 },    {   0,   0, 171 },    {   0,   0, 174 },    {   0,   0, 177 },    {   0,   0, 180 },    {   0,   0, 182 },    {   0,   0, 185 },
    {   0,   0, 188 },    {   0,   0, 191 },    {   0,   0, 194 },    {   0,   0, 196 },    {   0,   0, 199 },    {   0,   0, 202 },    {   0,   0, 205 },    {   0,   0, 208 },
    {   0,   0, 210 },    {   0,   0, 213 },    {   0,   0, 216 },    {   0,   0, 219 },    {   0,   0, 222 },    {   0,   0, 224 },    {   0,   0, 227 },    {   0,   0, 230 },
    {   0,   0, 233 },    {   0,   0, 236 },    {   0,   0, 238 },    {   0,   0, 241 },    {   0,   0, 244 },    {   0,   0, 247 },    {   0,   0, 250 },    {   0,   0, 252 },
    {   1,   1, 255 },    {   5,   5, 255 },    {   8,   8, 255 },    {  13,  13, 255 },    {  17,  17, 255 },    {  21,  21, 255 },    {  25,  25, 255 },    {  29,  29, 255 },
    {  33,  33, 255 },    {  37,  37, 255 },    {  40,  40, 255 },    {  45,  45, 255 },    {  49,  49, 255 },    {  53,  53, 255 },    {  57,  57, 255 },    {  61,  61, 255 },
    {  65,  65, 255 },    {  69,  69, 255 },    {  72,  72, 255 },    {  77,  77, 255 },    {  81,  81, 255 },    {  85,  85, 255 },    {  89,  89, 255 },    {  93,  93, 255 },
    {  97,  97, 255 },    { 101, 101, 255 },    { 104, 104, 255 },    { 109, 109, 255 },    { 113, 113, 255 },    { 117, 117, 255 },    { 121, 121, 255 },    { 125, 125, 255 },
    { 129, 129, 255 },    { 133, 133, 255 },    { 136, 136, 255 },    { 141, 141, 255 },    { 145, 145, 255 },    { 149, 149, 255 },    { 153, 153, 255 },    { 157, 157, 255 },
    { 161, 161, 255 },    { 165, 165, 255 },    { 168, 168, 255 },    { 173, 173, 255 },    { 177, 177, 255 },    { 181, 181, 255 },    { 185, 185, 255 },    { 189, 189, 255 },
    { 193, 193, 255 },    { 197, 197, 255 },    { 200, 200, 255 },    { 205, 205, 255 },    { 209, 209, 255 },    { 213, 213, 255 },    { 217, 217, 255 },    { 221, 221, 255 },
    { 225, 225, 255 },    { 229, 229, 255 },    { 232, 232, 255 },    { 237, 237, 255 },    { 241, 241, 255 },    { 245, 245, 255 },    { 249, 249, 255 },    { 253, 253, 255 },
    { 255, 253, 253 },    { 255, 249, 249 },    { 255, 245, 245 },    { 255, 241, 241 },    { 255, 237, 237 },    { 255, 233, 233 },    { 255, 229, 229 },    { 255, 225, 225 },
    { 255, 221, 221 },    { 255, 217, 217 },    { 255, 213, 213 },    { 255, 209, 209 },    { 255, 205, 205 },    { 255, 201, 201 },    { 255, 197, 197 },    { 255, 193, 193 },
    { 255, 189, 189 },    { 255, 185, 185 },    { 255, 180, 180 },    { 255, 177, 177 },    { 255, 173, 173 },    { 255, 169, 169 },    { 255, 164, 164 },    { 255, 161, 161 },
    { 255, 157, 157 },    { 255, 153, 153 },    { 255, 148, 148 },    { 255, 145, 145 },    { 255, 141, 141 },    { 255, 137, 137 },    { 255, 132, 132 },    { 255, 129, 129 },
    { 255, 125, 125 },    { 255, 121, 121 },    { 255, 117, 117 },    { 255, 113, 113 },    { 255, 109, 109 },    { 255, 105, 105 },    { 255, 101, 101 },    { 255,  97,  97 },
    { 255,  93,  93 },    { 255,  89,  89 },    { 255,  85,  85 },    { 255,  81,  81 },    { 255,  77,  77 },    { 255,  73,  73 },    { 255,  69,  69 },    { 255,  65,  65 },
    { 255,  61,  61 },    { 255,  56,  56 },    { 255,  53,  53 },    { 255,  48,  48 },    { 255,  45,  45 },    { 255,  40,  40 },    { 255,  37,  37 },    { 255,  32,  32 },
    { 255,  29,  29 },    { 255,  24,  24 },    { 255,  21,  21 },    { 255,  16,  16 },    { 255,  13,  13 },    { 255,   8,   8 },    { 255,   5,   5 },    { 255,   0,   0 },
    { 253,   0,   0 },    { 251,   0,   0 },    { 249,   0,   0 },    { 247,   0,   0 },    { 245,   0,   0 },    { 243,   0,   0 },    { 241,   0,   0 },    { 239,   0,   0 },
    { 237,   0,   0 },    { 235,   0,   0 },    { 233,   0,   0 },    { 231,   0,   0 },    { 229,   0,   0 },    { 227,   0,   0 },    { 225,   0,   0 },    { 223,   0,   0 },
    { 221,   0,   0 },    { 219,   0,   0 },    { 217,   0,   0 },    { 215,   0,   0 },    { 213,   0,   0 },    { 211,   0,   0 },    { 209,   0,   0 },    { 207,   0,   0 },
    { 205,   0,   0 },    { 203,   0,   0 },    { 201,   0,   0 },    { 199,   0,   0 },    { 197,   0,   0 },    { 195,   0,   0 },    { 193,   0,   0 },    { 191,   0,   0 },
    { 189,   0,   0 },    { 187,   0,   0 },    { 185,   0,   0 },    { 183,   0,   0 },    { 181,   0,   0 },    { 179,   0,   0 },    { 177,   0,   0 },    { 175,   0,   0 },
    { 173,   0,   0 },    { 171,   0,   0 },    { 169,   0,   0 },    { 167,   0,   0 },    { 165,   0,   0 },    { 163,   0,   0 },    { 161,   0,   0 },    { 159,   0,   0 },
    { 157,   0,   0 },    { 155,   0,   0 },    { 153,   0,   0 },    { 151,   0,   0 },    { 149,   0,   0 },    { 147,   0,   0 },    { 145,   0,   0 },    { 143,   0,   0 },
    { 141,   0,   0 },    { 139,   0,   0 },    { 137,   0,   0 },    { 135,   0,   0 },    { 133,   0,   0 },    { 131,   0,   0 },    { 129,   0,   0 },    { 127,   0,   0 },
};


void start_ffmpeg(settings config) {
    std::string size = std::to_string(config.grid_size) + "x" + std::to_string(config.grid_size);
    std::string fr = std::to_string(config.framerate);
    std::string cmd = "ffmpeg -f rawvideo -pix_fmt rgb24 -s " + size + " -r " + fr + " -i - -c:v ";

    int idx = config.video_filename.find_first_of('.');
    if(idx != std::string::npos) {
        std::string ext = config.video_filename.substr(idx + 1);

        if(ext == "mkv") { 
            cmd += "ffv1 -f matroska -y ";
        }
        else if (ext == "avi") { 
            cmd += "mpeg4 -qscale:v 2 -f avi -y ";
        }
        else if (ext == "mov") {
            cmd += "prores_ks -profile:v 3 -f mov -y ";
        } else {
            cmd += "libx264 -preset veryfast -crf 23 -y ";
        }
    } else {
        cmd += "libx264 -preset veryfast -crf 23 -y ";
    }

    cmd += config.video_filename;
    cmd += " " + config.ffmpeg_cmd;

    std::cout << "[INFO] ffmpeg query: " << cmd << std::endl;
 
    ffmpeg = popen(cmd.c_str(), "w");
    if (!ffmpeg) {
        perror("Unable to launch ffmpeg!");
        std::exit(1);
    }
    streaming_active = true;
}

void stream_rgb_frame(const uint8_t* rgb_frame, int width, int height) {
    if (streaming_active && ffmpeg) {
        std::lock_guard<std::mutex> lock(ffmpeg_mutex);
        fwrite(rgb_frame, sizeof(uint8_t), width * height * 3, ffmpeg);
        fflush(ffmpeg);
    }
}

void end_ffmpeg() {
    streaming_active = false;
    if (ffmpeg) {
        std::lock_guard<std::mutex> lock(ffmpeg_mutex);
        pclose(ffmpeg);
    }
}

void apply_colormap_rgb_log(uint8_t* out_rgb, const double* in, int size, double vmin, double vmax) {
    constexpr double epsilon = 1e-10;
    double log_min = std::log10(vmin + epsilon);
    double log_max = std::log10(vmax + epsilon);
    double scale = 255.0 / (log_max - log_min);

    for (int i = 0; i < size; ++i) {
        double val = std::max(in[i], epsilon);
        double log_val = std::log10(val);
        double norm = (log_val - log_min) * scale;
        norm = std::clamp(norm, 0.0, 255.0);
        int idx = static_cast<int>(norm);

        out_rgb[3*i + 0] = viridis[idx][0];
        out_rgb[3*i + 1] = viridis[idx][1];
        out_rgb[3*i + 2] = viridis[idx][2];
    }
}

void apply_colormap_rgb_gamma(uint8_t* out_rgb, const double* in, int size, double vmin, double vmax, double gamma) {
    double scale = 1.0 / (vmax - vmin);

    for (int i = 0; i < size; ++i) {
        double norm = (in[i] - vmin) * scale;
        norm = std::clamp(norm, 0.0, 1.0);
        norm = std::pow(norm, gamma);
        int idx = static_cast<int>(norm * 255.0);
        idx = std::clamp(idx, 0, 255);

        out_rgb[3*i + 0] = seismic[idx][0];
        out_rgb[3*i + 1] = seismic[idx][1];
        out_rgb[3*i + 2] = seismic[idx][2];
    }
}

void apply_colormap_rgb(uint8_t* out_rgb, const double* in, int size, double vmin, double vmax) {
    double scale = 255.0 / (vmax - vmin);
    for (int i = 0; i < size; ++i) {
        double norm = (in[i] - vmin) * scale;
        norm = std::max(0.0, std::min(255.0, norm));
        int idx = static_cast<int>(norm);

        out_rgb[3*i + 0] = viridis[idx][0]; // R
        out_rgb[3*i + 1] = viridis[idx][1]; // G
        out_rgb[3*i + 2] = viridis[idx][2]; // B
    }
}